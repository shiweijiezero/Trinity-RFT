# Trinity 项目部署教程

## 一、环境安装

### 1.1 安装项目依赖

```bash
# 安装项目（开发模式）
pip install -e .

# 如果不需要更新依赖，使用以下命令
pip install -e . --no-deps
```

### 1.2 安装特殊依赖包

以下是必需的特定版本依赖：

```bash
# vLLM（推荐版本）
pip install vllm==10.0.2

# Click
pip install click==0.8.1

# Flash Attention
pip install flash-attn==2.8.1 --no-build-isolation
```

### 1.3 配置环境变量

需要设置以下环境变量：

```bash
# Hugging Face Token（必需）
export HF_TOKEN=your_huggingface_token

# Weights & Biases API Key（如果使用 wandb 监控）
export WANDB_API_KEY=your_wandb_api_key
```

---

## 二、项目结构

### 2.1 目录说明

- **配置文件路径**: `examples/R3L/`
- **工作流路径**: `trinity/common/workflows/envs/R3L/`

### 2.2 支持的环境（5个）

1. **ALFWORLD** - 交互式文本游戏环境
2. **Webshop** - 电商购物环境（需要约 1T 内存）
3. **ScienceWorld** - 科学实验环境
4. **DAPO** - 数学问题环境
5. **CountDown** - 倒计时游戏环境

### 2.3 支持的算法（5种）

**基线方法**:
- GRPO
- OPMD
- RAFT

**我们的方法**:
- OPMD + Reweight Adv
- R3L

### 2.4 实验规模

- 环境数量: 5
- 算法数量: 5
- 模型规模: 2（Qwen-2.5-1.5B 和 Qwen-2.5-7B）
- **总实验数**: 5 × 5 × 2 = **50 个实验**

> **注意**: Webshop 环境需要约 1T 内存，如果内存不足，建议先跳过该环境。

---

## 三、参数配置

### 3.1 常用配置参数

以 `examples/R3L/alfworld/grpo_1.5B.yaml` 为例：

| 参数 | 说明 | 示例值 |
|------|------|--------|
| `gpu_per_node` | 节点上的 GPU 总数 | 8 |
| `engine_num` | 用于 rollout 的 GPU 数量 | 6（剩余 2 卡用于训练）|
| `gpu_memory_utilization` | 每张卡的显存使用率 | 0.7（70%，防止显存溢出）|
| `save_interval` | 每 N 步保存一次模型 | 20 |
| `monitor_type` | 监控工具类型 | wandb / tensorboard / none |

### 3.2 GPU 资源分配建议

- **1.5B 模型**: 2 卡训练，其余卡用于 rollout
- **7B 模型**: 4 卡训练，其余卡用于 rollout

### 3.3 checkpoint 说明

- 使用相同启动命令会自动从上次保存的 checkpoint 继续训练
- 如需从头训练，需删除对应的 checkpoint 文件夹和 .db 文件

---

## 四、运行实验

### 4.1 启动 Ray

在项目根目录下启动 Ray（只需启动一次）：

```bash
# 指定使用的 GPU 并启动 Ray
CUDA_VISIBLE_DEVICES=0,1,2,3,4,5,6,7 ray start --head
```

> **重要**: 必须在项目根目录启动 Ray，确保相对路径正确。

### 4.2 运行训练

基本命令格式：

```bash
trinity run --config <yaml配置文件路径>
```

#### 示例：ALFWORLD 环境（1.5B 模型）

```bash
# GRPO 算法
trinity run --config examples/R3L/alfworld/grpo_1.5B.yaml

# OPMD 算法
trinity run --config examples/R3L/alfworld/opmd_1.5B.yaml

# OPMD + R3L 算法
trinity run --config examples/R3L/alfworld/opmd_R3L_1.5B.yaml

# OPMD + Reweight Adv 算法
trinity run --config examples/R3L/alfworld/opmd_reweight_adv_1.5B.yaml

# RAFT 算法
trinity run --config examples/R3L/alfworld/RAFT_1.5B.yaml
```

#### 示例：ALFWORLD 环境（7B 模型）

```bash
trinity run --config examples/R3L/alfworld/grpo_7B.yaml
trinity run --config examples/R3L/alfworld/opmd_7B.yaml
trinity run --config examples/R3L/alfworld/opmd_R3L_7B.yaml
trinity run --config examples/R3L/alfworld/opmd_reweight_adv_7B.yaml
trinity run --config examples/R3L/alfworld/RAFT_7B.yaml
```

其他环境的配置文件位于 `examples/R3L/<环境名>/` 目录下，使用方式相同。

### 4.3 从头开始训练

如需重新开始实验，需删除相应的 checkpoint 和数据库文件：

```bash
# 删除数据库文件
rm alfworld_grpo_baseline_1.5B.db

# 删除 checkpoint 目录
rm -r checkpoints/ALFWORLD/ALFWORLD_RFT_Qwen_1.5B_GRPO_Baseline/
```

### 4.4 关闭 Ray

```bash
# 正常关闭
ray stop

# 强制关闭
ray stop --force
```

---

## 五、特殊环境数据准备

### 5.1 ALFWORLD 环境

#### 步骤 1: 安装 alfworld

```bash
pip install alfworld
```

#### 步骤 2: 下载数据

```bash
# 方式 1: 自动下载到 ~/.cache/alfworld/
alfworld-download

# 方式 2: 指定下载路径
alfworld-download --data-dir ./alf-data
```

#### 步骤 3: 修改数据路径配置

编辑 `examples/R3L/alfworld/get_alfworld_data.py` 文件：

```python
# 第 11 行，修改为你的实际数据路径
alfworld_data_root = "/你的本地路径/alfworld/json_2.1.1"
```

> **注意**: 保留路径末尾的 `json_2.1.1`

#### 步骤 4: 处理数据

```bash
cd examples/R3L/alfworld
python get_alfworld_data.py
```

处理后的数据将保存在 `examples/R3L/alfworld/` 目录下。

#### 步骤 5: 开始训练

```bash
trinity run --config examples/R3L/alfworld/grpo_7B.yaml
```

### 5.2 Webshop 环境

（数据准备步骤待补充）

### 5.3 ScienceWorld 环境

（数据准备步骤待补充）

---

## 六、实验监控与结果记录

### 6.1 实验运行建议

- 实验不需要等进度条跑完
- 观察到收敛或记录峰值后即可停止
- 如果崩溃，记录崩溃前的高点

### 6.2 需要记录的指标

#### 所有实验
- **Eval 结果**（必需）

#### 特殊环境额外指标

| 环境 | 额外指标 |
|------|----------|
| DAPO | 多个测试集的结果 |
| Webshop | success、平均使用 step |
| R3L 算法 | rollout 中的 improve 比例 |

---

## 七、待开发功能

### 7.1 待新增算法
- DAPO

### 7.2 待新增环境
- Sokoban
- Gym-Card (包括 BlackJack、EZPoints、NumberLine)

---

## 八、快速参考

### 8.1 完整工作流程

```bash
# 1. 设置环境变量
export HF_TOKEN=your_token
export WANDB_API_KEY=your_key

# 2. 启动 Ray
cd /path/to/trinity
CUDA_VISIBLE_DEVICES=0,1,2,3,4,5,6,7 ray start --head

# 3. 运行实验
trinity run --config examples/R3L/alfworld/grpo_1.5B.yaml

## 4. 实验结束后关闭 Ray
#ray stop
```

### 8.2 常见问题

**Q: 如何更改使用的 GPU？**
A: 修改 `CUDA_VISIBLE_DEVICES` 环境变量和配置文件中的 `gpu_per_node`、`engine_num` 参数。

**Q: 显存不足怎么办？**
A: 降低 `gpu_memory_utilization` 参数（如从 0.7 改为 0.5）。

**Q: 如何切换监控工具？**
A: 修改配置文件中的 `monitor_type` 参数（wandb / tensorboard / none）。

**Q: checkpoint 在哪里？**
A: 在 `checkpoints/<环境名>/<具体实验名>/` 目录下。

---

## 九、目前需要的实验任务列表

### ALFWORLD 环境（7B 模型）

```bash
trinity run --config examples/R3L/alfworld/grpo_7B.yaml
trinity run --config examples/R3L/alfworld/opmd_7B.yaml
trinity run --config examples/R3L/alfworld/opmd_R3L_7B.yaml
trinity run --config examples/R3L/alfworld/opmd_reweight_adv_7B.yaml
trinity run --config examples/R3L/alfworld/RAFT_7B.yaml
```

（其他环境和模型的实验列表可参考 `examples/R3L/` 目录结构）
